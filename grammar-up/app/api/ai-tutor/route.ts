import OpenAI from 'openai'
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { aiTutorRateLimiter } from '@/lib/rate/rate_limit' // ‚Üê Import ƒë∆°n gi·∫£n

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    
    if (authError || !user) {
      return NextResponse.json(
        { error: 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng AI Tutor' },
        { status: 401 }
      )
    }

    console.log('‚úÖ User authenticated:', user.id)

    // Rate limiting - ƒê∆°n gi·∫£n h∆°n v·ªõi Upstash
    const { success, limit, remaining, reset } = await aiTutorRateLimiter.limit(user.id)

    if (!success) {
      return NextResponse.json(
        { 
          error: 'B·∫°n ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng AI Tutor mi·ªÖn ph√≠ (3 l·∫ßn/ng√†y).',
          remaining: 0,
          reset: Math.floor(reset / 1000), // reset l√† milliseconds
        },
        { status: 429 }
      )
    }

    console.log('‚úÖ Rate limit OK:', { remaining, limit })

    const { question, userAnswer, correctAnswer, questionType } = await request.json()

    if (!question || !userAnswer || !correctAnswer || !questionType) {
      return NextResponse.json(
        { error: 'Thi·∫øu th√¥ng tin c√¢u h·ªèi' },
        { status: 400 }
      )
    }

    console.log('ü§ñ Calling OpenAI...')

    const prompt = `You are a friendly Gen Z English tutor. A student just answered an English question.

Question: ${question}
Student's answer: ${userAnswer}
Expected correct answer: ${correctAnswer}
Question type: ${questionType}

YOUR TASK:
1. First, independently analyze if the student's answer is grammatically correct
2. Check for spelling, grammar, and sentence structure errors
3. Compare with the expected answer
4. If the student is ACTUALLY CORRECT but different from expected answer, acknowledge it!

IMPORTANT: 
- The "correct answer" might be wrong! Use your grammar expertise to judge.
- For "Neither...nor" / "Either...or": verb agrees with CLOSEST subject
- Be fair and accurate in your assessment

Response format (in Vietnamese, Gen Z friendly):
1. Greeting: Use "H·∫ø lu" or "√Ä c√¢u n√†y..." (1 line)
2. Analysis: 
   - If student is WRONG: Explain why (grammar rules, spelling, etc.)
   - If student is ACTUALLY RIGHT but marked wrong: "√ä khoan, c√¢u n√†y b·∫°n l√†m ƒë√∫ng m√†! ƒê√°p √°n g·ª£i √Ω c√≥ v·∫ª b·ªã nh·∫ßm..."
   - If expected answer is wrong: Point it out clearly
3. Correct explanation: Explain the right grammar rule

Tone: Friendly, natural, Gen Z vibe
Length: Max 200 words, no numbered lists, not too academic

Think step by step before responding.`

    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: 'You are an expert English grammar tutor who is friendly, fair, and accurate. You can detect when provided "correct answers" are actually wrong. Always prioritize grammatical correctness over the given answer.'
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: 400,
    })

    const feedback = completion.choices[0].message.content

    console.log('‚úÖ OpenAI response received')
    console.log('üì§ Sending response:', {
      hasFeeback: !!feedback,
      remaining,
      limit,
      reset: Math.floor(reset / 1000)
    })
    return NextResponse.json({ 
      feedback,
      remaining, // ‚Üê Fix: b·ªè - 1
      limit,
      reset: Math.floor(reset / 1000),
    }, {
      headers: {
        'X-RateLimit-Limit': limit.toString(),
        'X-RateLimit-Remaining': remaining.toString(),
        'X-RateLimit-Reset': Math.floor(reset / 1000).toString(),
      }
    })

  } catch (error: any) {
    console.error('‚ùå AI Tutor Error:', error)
    
    if (error?.status === 429) {
      return NextResponse.json(
        { error: 'OpenAI API ƒëang qu√° t·∫£i, vui l√≤ng th·ª≠ l·∫°i sau' },
        { status: 503 }
      )
    }
    
    return NextResponse.json(
      { error: 'Kh√¥ng th·ªÉ t·∫°o feedback t·ª´ AI tutor' },
      { status: 500 }
    )
  }
}
